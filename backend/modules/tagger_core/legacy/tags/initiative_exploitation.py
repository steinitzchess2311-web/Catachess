"""
Initiative Exploitation tag detector.

Detects when a player successfully exploits initiative by improving evaluation
while also gaining mobility/activity.

Conditions:
- delta_eval >= INITIATIVE_BOOST (50cp / 100 = 0.5 pawns)
- mobility_delta > 0 (mobility increases)

Evidence:
- delta_eval: Evaluation improvement
- mobility_delta: Mobility change
- threshold: Initiative boost threshold
"""
from ...models import TagContext, TagEvidence
from ...config import INITIATIVE_BOOST


def detect(ctx: TagContext) -> TagEvidence:
    """
    Detect initiative exploitation.

    Args:
        ctx: Tag detection context

    Returns:
        TagEvidence with detection result
    """
    gates_passed = []
    gates_failed = []
    evidence = {}

    threshold = INITIATIVE_BOOST / 100.0  # Convert cp to pawns
    delta_eval = ctx.delta_eval
    mobility_delta = ctx.component_deltas.get("mobility", 0.0)

    # Store evidence
    evidence["delta_eval"] = delta_eval
    evidence["eval_improvement_cp"] = int(delta_eval * 100)
    evidence["mobility_delta"] = mobility_delta
    evidence["threshold"] = threshold
    evidence["phase"] = ctx.phase_bucket

    # Gate 1: Significant eval improvement
    if delta_eval >= threshold:
        gates_passed.append("eval_improvement")
    else:
        gates_failed.append("eval_improvement")

    # Gate 2: Mobility gain
    if mobility_delta > 0:
        gates_passed.append("mobility_gain")
    else:
        gates_failed.append("mobility_gain")

    # Fire if both gates pass
    fired = len(gates_passed) == 2

    # Compute confidence
    if fired:
        # Higher confidence for larger improvements
        eval_bonus = min(0.4, (delta_eval - threshold) * 0.3)
        mobility_bonus = min(0.3, mobility_delta * 0.8)
        confidence = 0.5 + eval_bonus + mobility_bonus
    else:
        confidence = 0.0

    return TagEvidence(
        tag="initiative_exploitation",
        fired=fired,
        confidence=min(1.0, confidence),
        evidence=evidence,
        gates_passed=gates_passed,
        gates_failed=gates_failed,
    )


__all__ = ["detect"]
