# Stage 3 - 上线迁移与 Legacy 退役（产品级必做）

本文件是 Stage 3 的概览。更细拆分见：`stage3a.md`、`stage3b.md`、`stage3c.md`、`stage3d.md`。

## 约束（必须写在每个 stage 文档开头）
- [ ] 每完成一项任务，必须勾选对应 checkbox。
- [ ] 如果遇到阻塞或不确定，必须直接写明问题，不允许猜测后勾选。
- [ ] 禁止“先勾选后补做”。
- [ ] 禁止谎报进度；我会抽查对比代码。

---

## 本 Stage 目标（产品级）
把 PGN v2 从“可用”推进到“可上线”：包含灰度、回滚、迁移、数据一致性、性能与监控闭环，并正式退役 legacy。

---

## 分计划（Checklist）

### A. 灰度与开关
- [ ] 确认 ShowDTO 前端开关默认值与切换策略
- [ ] 确认后端是否需要全局开关（环境变量）
- [ ] 形成灰度清单（哪些用户/工作区先开）

### B. 数据迁移与一致性
- [ ] 执行全量扫描：PGN/R2/DB 对齐
- [ ] 修复不一致项
- [ ] 形成迁移报告

### C. 性能与容量
- [ ] 评估大 PGN 导入与渲染性能
- [ ] 评估 tagger/engine 负载
- [ ] 明确限流策略

### D. Legacy 退役
- [ ] 明确哪些 legacy 模块保留（仅回滚）
- [ ] 明确哪些 legacy 接口停用
- [ ] 更新文档与对外说明

---

## 输出物（本阶段交付）
- 灰度开关方案与回滚策略
- 迁移扫描与修复报告
- 性能基准与容量评估
- Legacy 退役清单

