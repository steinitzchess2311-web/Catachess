# Stage 3A - 灰度发布与回滚（前后端切换）

## 约束（必须写在每个 stage 文档开头）
- [ ] 每完成一项任务，必须勾选对应 checkbox。
- [ ] 如果遇到阻塞或不确定，必须直接写明问题，不允许猜测后勾选。
- [ ] 禁止“先勾选后补做”。
- [ ] 禁止谎报进度；我会抽查对比代码。

---

## 本 Stage 目标（产品级）
确保新 PGN v2 能够安全灰度上线，并在出现问题时快速回滚。

---

## 分计划（Checklist）

### A. 前端开关（必须）
- [ ] 文件：`frontend/ui/modules/study/api/pgn.ts`
- [ ] 确认 `USE_SHOW_DTO` 默认值（建议 false）
- [ ] 确认 `toggleShowDTO()` 可启用/禁用
- [ ] 记录灰度策略：仅内部账号/白名单可启用

### B. 后端开关（建议）
- [ ] 新增环境变量：`PGN_V2_ENABLED`（默认 false）
- [ ] 在 `/show` 与 `/fen` 入口检查开关
- [ ] 如果关闭：返回 404 或 fallback

### C. 回滚方案
- [ ] 前端回滚：关闭 `USE_SHOW_DTO`
- [ ] 后端回滚：
  - [ ] `pgn_sync_service` 使用 `sync_chapter_pgn_legacy()`
  - [ ] 禁用 `/show` 接口
- [ ] 写明“回滚验证步骤”

---

## 输出物（本阶段交付）
- 前端/后端双开关
- 明确灰度范围
- 回滚流程文档

