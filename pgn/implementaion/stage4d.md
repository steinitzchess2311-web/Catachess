# Stage 4D - 监控与对外说明（运维与客服可用）

## 约束（必须写在每个 stage 文档开头）
- [ ] 每完成一项任务，必须勾选对应 checkbox。
- [ ] 如果遇到阻塞或不确定，必须直接写明问题，不允许猜测后勾选。
- [ ] 禁止“先勾选后补做”。
- [ ] 禁止谎报进度；我会抽查对比代码。

---

## 本 Stage 目标（产品级）
让运维与客服能定位“PGN 找不到”的问题，并可执行修复。

---

## 分计划（Checklist）

### A. 日志与告警埋点
- [ ] 在以下位置添加结构化日志：
  - [ ] `pgn_sync_service.py`（写 R2 成功/失败）
  - [ ] `study PGN GET API`（读 R2 失败）
- [ ] 日志字段必须包含：
  - [ ] `study_id`
  - [ ] `chapter_id`
  - [ ] `r2_key`
  - [ ] `error_code`

### B. 告警条件（产品级）
- [ ] 定义以下告警触发条件：
  - [ ] 连续 N 次 R2 404
  - [ ] r2_key 与 chapter_id 不一致
  - [ ] pgn_hash 与 R2 内容不一致

### C. 运维文档
- [ ] 新增文档：`docs/pgn/ops.md`
- [ ] 必须包含：
  - [ ] PGN 存储位置说明（R2 key 规则）
  - [ ] 如何运行扫描脚本
  - [ ] 如何执行重建 PGN
  - [ ] 常见故障排查流程

### D. 客服话术/FAQ
- [ ] 新增 FAQ：
  - [ ] “为什么 PGN 显示为空？”
  - [ ] “如何恢复？”

---

## 输出物（本阶段交付）
- 结构化日志
- 告警规则
- 运维文档与 FAQ

