# Stage 06 - Pipeline 实现（PGN → Tag 统计）

目标：实现核心处理逻辑。

## 一、执行步骤
1) 读取 R2 raw.pgn
2) 解析 PGN（仅主线）
3) 对每盘做 player 匹配
4) 遍历走子：仅统计目标棋手走子
5) 调用 tagger
6) 记录 tag 命中
7) 更新白/黑/总统计
8) 记录失败盘

## 二、主线定义
- 使用 chess.pgn 的 variation(0) 作为主线。
- 变体全部忽略（v1）。

## 三、统计写入策略
- 推荐“先累加到内存，再一次性写入”。\n- 锁策略：按 player_id + upload_id 维度做细粒度锁，避免不同上传互相阻塞。\n- 写入时使用事务：校验去重表后再写入统计增量。

## 四、任务分片与断点续跑\n- 每批处理固定盘数（如 50 盘一批）。\n- 每批结束写入 checkpoint（已处理 game_hash 列表）。\n- worker 中断后从 checkpoint 继续。

## Checklist
- [ ] R2 读取流程定义清晰
- [ ] 主线解析规则确认
- [ ] 只统计目标棋手走子
- [ ] 统计写入策略确认
- [ ] 失败盘记录机制确认
